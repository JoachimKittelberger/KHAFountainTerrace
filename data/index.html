<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="src/bootstrap.min.css" rel="stylesheet" type="text/css" >

    
    <style type="text/css">
      /* Style, um die Checkboxen der Switche auf eine große Größe zu bringen */
      .custom-control-input:checked ~ .custom-control-label::before {
        background-color: green;
        border-color: #004d00;
      }
      .custom-switch.custom-switch-lg {
        padding-bottom: 1rem;
        padding-left: 2.25rem;
      }
      .custom-switch.custom-switch-lg .custom-control-label {
        padding-left: 0.75rem;
        padding-top: 0.15rem;
      }
      .custom-switch.custom-switch-lg .custom-control-label::before {
        border-radius: 1rem;
        height: 1.5rem;
        width: 2.5rem;
      }
      .custom-switch.custom-switch-lg .custom-control-label::after {
        border-radius: 0.65rem;
        height: calc(1.5rem - 4px);
        width: calc(1.5rem - 4px);
      }
      .custom-switch.custom-switch-lg .custom-control-input:checked ~ .custom-control-label::after {
        transform: translateX(1rem);
      }

      /* Style, um die Checkboxen der Switche auf eine sehr große Größe zu bringen */
      .custom-switch.custom-switch-xl {
        padding-bottom: 1rem;
        padding-left: 2.25rem;
      }
      .custom-switch.custom-switch-xl .custom-control-label {
        padding-left: 2rem;
        padding-top: 0.5rem;
      }
      .custom-switch.custom-switch-xl .custom-control-label::before {
        border-radius: 1rem;
        height: 2rem;
        width: 3.5rem;
      }
      .custom-switch.custom-switch-xl .custom-control-label::after {
        border-radius: 2rem;
        height: calc(2rem - 4px);
        width: calc(2rem - 4px);
      }
      .custom-switch.custom-switch-xl .custom-control-input:checked ~ .custom-control-label::after {
        transform: translateX(1.5rem);
      }

      /* Style, um den Titel etwas kleiner zu machen */
      .jumbotron {
        padding-top: 5px !important;
        padding-bottom: 5px !important;
      }
    </style>


    <title>Brunnen Terrasse</title>
  </head>

  <body>
    <div class="jumbotron jumbotron-fluid">
      <div class="container">
        <h1 class="display-5">Brunnen auf Terrasse</h1>
        <p class="lead">Joachim Kittelberger (V%Version%)</p>
      </div>
    </div>


    <form>
      <div class="container p-0 my-0">
        <div class="font-weight-bold my-1">Fontäne:</div>

        <div class="container p-2">
          <label class="" for="switchSolar">Solar</label>
          <div class="custom-control custom-switch d-inline" id="switchSolar">
              <input type="checkbox" class="custom-control-input" value="" onchange="toggleSwitch(this)" id="buttonSolar" disabled>
              <label class="custom-control-label" for="buttonSolar">Steckdose</label>
          </div>

          <div>
            <label class="" for="switchPump">Pumpe</label>
            <div class="custom-control custom-switch d-inline" id="switchPump">
                <input type="checkbox" class="custom-control-input" value="" onchange="toggleSwitch(this)" id="buttonPump" disabled>
                <label class="custom-control-label" for="buttonPump"></label>
            </div>
          </div>

          <div>
            <label for="pumpHeight">Höhe</label>
            <input type="range" min="0" max="255" value="0" id="pumpHeight" onchange="changeInputSliderHeight(this)">
          </div>
        </div>
      </div>
      <hr class="my-1"></hr>


      <div class="container p-0 my-0">
        <div class="font-weight-bold my-1">LED Brunnen:</div>

        <div class="container p-2">
          <label class="" for="switchLEDBrunnen">LEDs</label>
          <div class="custom-control custom-switch d-inline" id="switchLEDBrunnen">
            <input type="checkbox" class="custom-control-input" value="" onchange="toggleSwitch(this)" id="buttonLEDBrunnen" disabled>
            <label class="custom-control-label" for="buttonLEDBrunnen"></label>
          </div>

          <div>
            <label for="brunnenBrightness">Helligkeit</label>
            <input type="range" min="0" max="255" value="0" id="brunnenBrightness" onchange="changeInputSliderBrightness(this)">
          </div>

          <div>
            <label for="farbeBrunnen">Farbe</label>
            <input type="color" id="farbeBrunnen" value="#f6b73c" onchange="changeColor(this)">
          </div>

          <p>Lichteffekt
            <select id="lightEffectBrunnen" onchange="changeLightEffect(this)">
              %LightEffectOptions%
            </select>
          </p>
          
          <div>
            <label for="brunnenSpeed">Geschwindigkeit Effekt</label>
            <input type="range" min="20" max="2000" value="0" id="brunnenSpeed" onchange="changeInputSliderSpeed(this)">
          </div>
    
        </div>
        <hr class="my-1"></hr>


        <div class="container p-0 my-0">
        <div class="font-weight-bold my-1">LED Ring:</div>

        <div class="container p-2">
          <label class="" for="switchLEDRing">LEDs</label>
          <div class="custom-control custom-switch d-inline" id="switchLEDRing">
            <input type="checkbox" class="custom-control-input" value="" onchange="toggleSwitch(this)" id="buttonLEDRing" disabled>
            <label class="custom-control-label" for="buttonLEDRing"></label>
          </div>

          <div>
            <label for="ringBrightness">Helligkeit</label>
            <input type="range" min="0" max="255" value="0" id="ringBrightness" onchange="changeInputSliderBrightness(this)">
          </div>

          <div>
            <label for="farbeRing">Farbe</label>
            <input type="color" id="farbeRing" value="#f6b73c" onchange="changeColor(this)">
          </div>

          <p>Lichteffekt
            <select id="lightEffectRing" onchange="changeLightEffect(this)">
              %LightEffectOptions%
            </select>
          </p>
          <div>
            <label for="ringSpeed">Geschwindigkeit Effekt</label>
            <input type="range" min="20" max="4000" value="0" id="ringSpeed" onchange="changeInputSliderSpeed(this)">
          </div>

        </div>
      </div>
      <hr class="my-1"></hr>


      <div class="container p-0 my-0">
        <div class="font-weight-bold my-2">LED Stufe:</div>

        <div class="container p-2">
          <label class="" for="switchLEDStufe">LEDs</label>
          <div class="custom-control custom-switch d-inline" id="switchLEDStufe">
            <input type="checkbox" class="custom-control-input" value="" onchange="toggleSwitch(this)" id="buttonLEDStufe" disabled>
            <label class="custom-control-label" for="buttonLEDStufe"></label>
          </div>

          <div>
            <label for="stufeBrightness">Helligkeit</label>
            <input type="range" min="0" max="255" value="0" id="stufeBrightness" onchange="changeInputSliderBrightness(this)">
          </div>

          <div>
            <label for="farbeStufe">Farbe</label>
            <input type="color" id="farbeStufe" value="#f6b73c" onchange="changeColor(this)">
          </div>

          <p>Lichteffekt
            <select id="lightEffectStufe" onchange="changeLightEffect(this)">
              %LightEffectOptions%
            </select>
          </p>
          <div>
            <label for="stufeSpeed">Geschwindigkeit Effekt</label>
            <input type="range" min="20" max="2000" value="0" id="stufeSpeed" onchange="changeInputSliderSpeed(this)">
          </div>
        </div>
      </div>
      <hr class="my-1"></hr>

      <div class="container p-0 my-2">
        <div>
          <label class="font-weight-bold" for="switchPower">Gerät Ein/Aus</label>
          <div class="custom-control custom-switch d-inline" id="switchPower">
            <input type="checkbox" class="custom-control-input" value="" onchange="toggleSwitch(this)" id="buttonPower" disabled>
            <label class="custom-control-label" for="buttonPower"></label>
          </div>
        </div>
        <label id="temperatureDevice">Temperatur: 0.0 °C</label>
        <label id="humidityDevice">Luftfeuchte: 0.0 %</label>
      </div>
      <hr class="my-1"></hr>

<!-- 
        <p class="mt-4"><strong>LEDStufe</strong></p>
        <div class="custom-control custom-switch custom-switch-xl">
          <input type="checkbox" class="custom-control-input" onchange="toggleSwitch(this)" id="5" disabled>
          <label class="custom-control-label" for="5"></label>
        </div>
-->
      </div>
    </form>

  
  
    <!-- Optional JavaScript -->
    <!-- Bootstrap JS -->
    <script src="src/jquery-3.5.1.min.js"></script>
    <script src="src/bootstrap.bundle.min.js"></script>

    <script>
      
      // helperfunction for population of select LightEffects in case of a local file with no Placeholder calculation in ESP
      function populateSelect(target, min, max){
        if (!target) {
          return false;
        }
        else {
          var min = min || 0,
              max = max || min + 100;

          select = document.getElementById(target);

          for (var i = min; i<=max; i++){
              var opt = document.createElement('option');
              opt.value = i;
              opt.innerHTML = i;
              select.appendChild(opt);
          }
        }
      }
      //usage:
      //populateSelect('selectElementId',12,100);     // calling the function with all three values
      //populateSelect('anotherSelect');              // calling the function with only the 'id' ('min' and 'max' are set to defaults)
      //populateSelect('moreSelects', 50);            // calling the function with the 'id' and the 'min' (the 'max' is set to default)


      function changeInputSliderSpeed(element) {
        var animationTime = element.value;
        var s;

        if (element.id == "brunnenSpeed") {
          s = JSON.stringify({ledbrunnen : {lespeed: animationTime}});
        }
        if (element.id == "ringSpeed") {
          s = JSON.stringify({ledring : {lespeed: animationTime}});
        }
        if (element.id == "stufeSpeed") {
          s = JSON.stringify({ledstufe : {lespeed: animationTime}});
        }
        websocket.send(s);
        //console.log("WebSocket send: " + s);
      }


      
      function changeLightEffect(element) {
        //console.log(element);
        var index = element.selectedIndex;
        var s;
        if (element.id == "lightEffectBrunnen") {
          s = JSON.stringify({ledbrunnen : {lighteffect: index}});
        }
        if (element.id == "lightEffectRing") {
          s = JSON.stringify({ledring : {lighteffect: index}});
        }
        if (element.id == "lightEffectStufe") {
          s = JSON.stringify({ledstufe : {lighteffect: index}});
        }
        websocket.send(s);
        //console.log("WebSocket send: " + s);
      }


      // um htmlcode und javascript nicht zu mischen, sollte event in JAvaSCript defineirt werden:
//      document.getElementById('choice').onchange = function() {
//        alert(this.value);
//      }



      
      function onNewMessage(event) {
        //console.log("WebSocket Receive: " + event.data);

        try {
          const rootObj = JSON.parse(event.data)
          console.log(rootObj);

          if ("ledbrunnen" in rootObj) {
            var ledbrunnen = rootObj.ledbrunnen;
            if ("mode" in ledbrunnen) {
              var modeOn = ledbrunnen.mode == "on";
              $('#buttonLEDBrunnen').prop('checked', modeOn);
            }

            if ("brightness" in ledbrunnen) {
              $('#brunnenBrightness').prop('value', ledbrunnen.brightness);
            }

            if ("colorRGB" in ledbrunnen) {
              $('#farbeBrunnen').prop('value', ledbrunnen.colorRGB);
            }

            if ("lighteffect" in ledbrunnen) {
              $('#lightEffectBrunnen').prop('selectedIndex', ledbrunnen.lighteffect);
            }

            if ("lespeed" in ledbrunnen) {
              $('#brunnenSpeed').prop('value', ledbrunnen.lespeed);
            }
          }
 
          
          if ("ledring" in rootObj) {
            var ledring = rootObj.ledring;
            if ("mode" in ledring) {
              var modeOn = ledring.mode == "on";
              $('#buttonLEDRing').prop('checked', modeOn);
            }

            if ("brightness" in ledring) {
              $('#ringBrightness').prop('value', ledring.brightness);
            }

            if ("colorRGB" in ledring) {
              $('#farbeRing').prop('value', ledring.colorRGB);
            }

            if ("lighteffect" in ledring) {
              $('#lightEffectRing').prop('selectedIndex', ledring.lighteffect);
            }

            if ("lespeed" in ledring) {
              $('#ringSpeed').prop('value', ledring.lespeed);
            }
          }

          if ("ledstufe" in rootObj) {
            var ledstufe = rootObj.ledstufe;
            if ("mode" in ledstufe) {
              var modeOn = ledstufe.mode == "on";
              $('#buttonLEDStufe').prop('checked', modeOn);
            }

            if ("brightness" in ledstufe) {
              $('#stufeBrightness').prop('value', ledstufe.brightness);
            }

            if ("colorRGB" in ledstufe) {
              $('#farbeStufe').prop('value', ledstufe.colorRGB);
            }

            if ("lighteffect" in ledstufe) {
              $('#lightEffectStufe').prop('selectedIndex', ledstufe.lighteffect);
            }

            if ("lespeed" in ledstufe) {
              $('#stufeSpeed').prop('value', ledstufe.lespeed);
            }
          }
 

          if ("fontain" in rootObj) {
            var fontain = rootObj.fontain;
            if ("solar" in fontain) {
              var solarOn = fontain.solar == "off";
              $('#buttonSolar').prop('checked', solarOn);
            }
            if ("mode" in fontain) {
              var modeOn = fontain.mode == "on";
              $('#buttonPump').prop('checked', modeOn);
            }
            if ("height" in fontain) {
              $('#pumpHeight').prop('value', fontain.height);
            }
          }
 
          if ("cmd" in rootObj) {
            var cmd = rootObj.cmd;
            if ("power" in cmd) {
              var powerOn = cmd.power == "on";
              $('#buttonPower').prop('checked', powerOn);
            }
          }

          if ("status" in rootObj) {
            var status = rootObj.status;
            if ("temperature" in status) {
              var temp = status.temperature;
              temp = temp.toFixed(2);
              var s = "Temperatur: " + temp + " °C"
              //console.log(s);
              $('#temperatureDevice').prop('innerHTML', s);
            }
            if ("humidity" in status) {
              var humidity = status.humidity;
              humidity = humidity.toFixed(1);
              var s = "Luftfeuchte: " + humidity + " %"
              //console.log(s);
              $('#humidityDevice').prop('innerHTML', s);
            }
          }


/*
          var i;
          for(i in rootObj){
            if(rootObj[i]instanceof Object){
              console.log(rootObj[i]);
            }
          }
*/
/*          var x = rootObj["ledbrunnen"].mode;
          console.log("ledbrunnen.mode: " + x);
          console.log(rootObj.ledbrunnen.mode);
*/

        } catch(err) {
          console.error(err);
        }

/*
        for (var i = 0; i < rootObj.switches.length; i++) {
          var id = rootObj.switches[i].id;
          var state = rootObj.switches[i].state;

          const cb = document.getElementById(id);
          if (cb.type == "checkbox") {
            cb.checked = state;
            cb.disabled = false;
          }         
        }
*/
      }

 
      function toggleSwitch(element) {
        var s;
        var onoff;

        if (element.id == "buttonSolar") {
          if (element.checked) {
            onoff = "off";
          } else { 
            onoff = "on";
          }
          s = JSON.stringify({fontain : {solar: onoff}});
        }


        if (element.checked) {
          onoff = "on";
        } else { 
          onoff = "off";
        }
        if (element.id == "buttonPump") {
          s = JSON.stringify({fontain : {mode: onoff}});
        }
        if (element.id == "buttonLEDBrunnen") {
          s = JSON.stringify({ledbrunnen : {mode: onoff}});
        }
        if (element.id == "buttonLEDRing") {
          s = JSON.stringify({ledring : {mode: onoff}});
        }
        if (element.id == "buttonLEDStufe") {
          s = JSON.stringify({ledstufe : {mode: onoff}});
        }
        if (element.id == "buttonPower") {
          s = JSON.stringify({cmd : {power: onoff}});
        }

        //element.disabled = true;      // set disabled and wait for response from WebService. This will set element to enabled
        websocket.send(s);
        //console.log("WebSocket send: " + s);
      }

      


      function changeColor(element) {
        var s;
        var color = element.value;

        if (element.id == "farbeBrunnen") {
          s = JSON.stringify({ledbrunnen : {colorRGB: color}});
        }
        if (element.id == "farbeRing") {
          s = JSON.stringify({ledring : {colorRGB: color}});
        }
        if (element.id == "farbeStufe") {
          s = JSON.stringify({ledstufe : {colorRGB: color}});
        }
        websocket.send(s);
        //console.log("WebSocket send: " + s);
      }


      function changeInputSliderHeight(element) {
        var s;
        var currentValue = element.value;
 
        if (element.id == "pumpHeight") {
          s = JSON.stringify({fontain : {height: currentValue}});
        }
        websocket.send(s);
        //console.log("WebSocket send: " + s);
      }
 

      function changeInputSliderBrightness(element) {
        var s;
        var currentValue = element.value;
 
        if (element.id == "brunnenBrightness") {
          s = JSON.stringify({ledbrunnen : {brightness: currentValue}});
        }
        if (element.id == "ringBrightness") {
          s = JSON.stringify({ledring : {brightness: currentValue}});
        }
        if (element.id == "stufeBrightness") {
          s = JSON.stringify({ledstufe : {brightness: currentValue}});
        }
        websocket.send(s);
        //console.log("WebSocket send: " + s);
      }


    </script>



    <script src="./credentials.js"></script>
    <script>
      // general Web-Socket Handling
      //var gateway = 'ws://192.168.1.1/ws';
      var gateway = gatewayURL;         // from credentials.js
      var bLocal = true;
      if (window.location.protocol === "file:") {
        console.log("Running as local file!");                      // like: file://<path>/index.html
      } else if (!window.location.host.replace(/(localhost|127\.0\.0\.1)(:\d+)?/i, "")) {
        console.log("Running on local server (ssh tunnel etc.)");   // like: "http://127.0.0.1:<my-port>"
      } else {
        console.log("Running normally, via web server");
        gateway = 'ws://' + window.location.host + '/ws';           // socket to the server
        bLocal = false;
      }


      var websocket;
      window.addEventListener('load', onLoad);
      
      function initWebSocket() {
          console.log("Trying to open a WebSocket connection to " + gateway);
          websocket = new WebSocket(gateway);
          websocket.onopen = onOpen;
          websocket.onclose = onClose;
          websocket.onmessage = onMessage;
      }
      function onOpen(event) {
          console.log('Connection opened');
          $('#buttonSolar').prop('disabled', false);
          $('#buttonPump').prop('disabled', false);
          $('#buttonLEDBrunnen').prop('disabled', false);
          $('#buttonLEDRing').prop('disabled', false);
          $('#buttonLEDStufe').prop('disabled', false);
          $('#buttonPower').prop('disabled', false);
          // TODO weitere aufnehmen





      }
      function onClose(event) {
          console.log('Connection closed');
          $('#buttonSolar').prop('disabled', true);
          $('#buttonPump').prop('disabled', true);
          $('#buttonLEDBrunnen').prop('disabled', true);
          $('#buttonLEDRing').prop('disabled', true);
          $('#buttonLEDStufe').prop('disabled', true);
          $('#buttonPower').prop('disabled', true);
          // TODO: weitere aufnehmen




          setTimeout(initWebSocket, 2000);
      }
      function onMessage(event) {
        onNewMessage(event);
      }
      function onLoad(event) {
        initWebSocket();

 
        // in local mode create elements für LightEffects selection because we have no Placholder on ESP32
        if (bLocal) {
          populateSelect('lightEffectBrunnen', 0, 10);
          populateSelect('lightEffectRing', 0, 10);
          populateSelect('lightEffectStufe', 0, 10);
        }
      }

    </script>
    
  </body>
</html>